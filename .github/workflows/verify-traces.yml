name: Verify Traces

on:
  push:
    branches: [ master, main ]
  pull_request:
    branches: [ master, main ]
  workflow_dispatch:

jobs:
  verify:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for commit range verification
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq bc
      
      - name: Verify latest commit
        run: |
          chmod +x scripts/verify-trace.sh
          bash scripts/verify-trace.sh HEAD || {
            echo "‚ùå Latest commit verification failed"
            exit 1
          }
      
      - name: Verify recent commits (last 10)
        run: |
          chmod +x scripts/verify-batch.sh
          bash scripts/verify-batch.sh HEAD~10..HEAD --json verification-report.json || {
            echo "‚ö†Ô∏è Some traces failed verification"
          }
      
      - name: Upload verification report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: verification-report
          path: verification-report.json
      
      - name: Check anchor coverage
        run: |
          TOTAL=$(find .agent-trace -name "*.json" | wc -l)
          ANCHORED=$(jq -r 'select(.metadata.solana_anchor.tx_hash != null)' .agent-trace/*.json | grep -c "tx_hash" || echo 0)
          COVERAGE=$(echo "scale=1; ($ANCHORED / $TOTAL) * 100" | bc)
          
          echo "üìä Anchor Coverage: $COVERAGE% ($ANCHORED/$TOTAL)"
          
          if (( $(echo "$COVERAGE < 95" | bc -l) )); then
            echo "‚ö†Ô∏è Anchor coverage below 95%"
            exit 1
          fi
      
      - name: Verification summary
        if: success()
        run: |
          echo "‚úÖ All verification checks passed!"
          echo "üîó RFC 0.1.0 compliance verified"
          echo "‚öì Solana anchoring confirmed"
          echo "ü§ñ AI authorship proven"
